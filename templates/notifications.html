{% extends "base.html" %}

{% block title %}BloodLink - Notifications{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-2xl font-bold text-gray-800">Notifications</h1>
        <button onclick="markAllRead()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
            Mark all as read
        </button>
    </div>

    <div class="space-y-4" id="notificationList">
        {% for notification in notifications %}
        <div
            class="bg-white p-4 rounded-lg shadow-sm border-l-4 {{ 'border-red-500 bg-red-50' if not notification.is_read else 'border-gray-200' }} transition-all hover:shadow-md">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center mb-1">
                        {% if notification.type == 'Broadcast' %}
                        <span class="bg-red-100 text-red-800 text-xs px-2 py-0.5 rounded-full mr-2">Broadcast</span>
                        {% elif notification.type == 'Collection' %}
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full mr-2">Action
                            Required</span>
                        {% else %}
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full mr-2">Info</span>
                        {% endif %}
                        <span class="text-xs text-gray-500">{{ notification.created_at.strftime('%Y-%m-%d %H:%M')
                            }}</span>
                    </div>
                    <p class="text-gray-800 {{ 'font-semibold' if not notification.is_read else '' }}">{{
                        notification.message }}</p>
                </div>
                {% if not notification.is_read %}
                <button onclick="markRead({{ notification.id }}, this)" class="ml-4 text-gray-400 hover:text-red-600"
                    title="Mark as read">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                </path>
            </svg>
            <p>No notifications yet.</p>
        </div>
        {% endfor %}
    </div>


    {% if total_pages > 1 %}
    <div class="flex justify-center mt-6">
        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            {% if page > 1 %}
            <a href="{{ url_for(request.endpoint, page=page-1) }}"
                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <span class="sr-only">Previous</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                    aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                        clip-rule="evenodd" />
                </svg>
            </a>
            {% endif %}

            <span
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-red-50 text-sm font-medium text-red-700 border-red-500">
                Page {{ page }} of {{ total_pages }}
            </span>

            {% if page < total_pages %} <a href="{{ url_for(request.endpoint, page=page+1) }}"
                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <span class="sr-only">Next</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                    aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                        clip-rule="evenodd" />
                </svg>
                </a>
                {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<script>
    function markRead(id, btn) {
        fetch(`/notifications/mark-read/${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Visually update the card
                    const card = btn.closest('.bg-white');
                    card.classList.remove('border-red-500', 'bg-red-50');
                    card.classList.add('border-gray-200');
                    card.querySelector('p').classList.remove('font-semibold');
                    btn.remove();
                    updateBadgeCount();
                }
            });
    }

    function markAllRead() {
        fetch('/notifications/mark-all-read', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    function updateBadgeCount() {
        // Simple decrement for immediate feedback, real count updates on reload
        const badge = document.getElementById('navNotificationBadge');
        if (badge) {
            let count = parseInt(badge.innerText) || 0;
            if (count > 0) {
                count--;
                badge.innerText = count;
                if (count === 0) badge.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}